<?php
$config = FreshRSS_Context::$user_conf->aiconverter ?? array();
$apiEndpoint = $config['api_endpoint'] ?? 'https://api.openai.com/v1/chat/completions';
$apiEndpointDisplay = html_entity_decode($apiEndpoint, ENT_QUOTES, 'UTF-8');
$apiToken = $config['api_token'] ?? '';
$apiTokenDisplay = html_entity_decode($apiToken, ENT_QUOTES, 'UTF-8');
$model = $config['model'] ?? 'gpt-4o-mini';
$defaultPrompt = $config['default_prompt'] ?? 'Extract and reformat the main article content into clean HTML. Follow these rules strictly:

1. **Text Content**: Extract ONLY the main article text in readable paragraphs. Do NOT add introductions, summaries, or conclusions that are not in the original article.

2. **Header Image**: If and ONLY if there is a clear header/featured image in the article, include it at the top using: <img src="URL" alt="description">
   - If there is NO image, do NOT include an <img> tag at all
   - Do NOT use placeholder images or generic images

3. **Comments**: If the article content includes comments (like from Reddit, YouTube, forums, etc.), extract and include the top 10 most relevant or upvoted comments at the end of the article. Format each comment as:
   <div class="comment">
     <p><strong>Author Name: </strong>Comment content here...</p>
   </div>
   - Include the author name and the full comment text
   - Only include comments if they are present in the source content
   - If there are no comments, skip this section entirely

4. **Source Link**: At the very bottom, add a right-aligned link: <p style="text-align: right;"><a href="{url}">Read original article</a></p>

5. **Formatting**: Preserve the article\'s structure (headings, lists, quotes) but remove ads, navigation, footers, and promotional content.

6. **Do NOT add**: Do not add any commentary, analysis, summaries, or content that is not part of the original article.

Return ONLY the HTML output, nothing else.';
$defaultPromptDisplay = html_entity_decode($defaultPrompt, ENT_QUOTES, 'UTF-8');

$feedConfigs = $config['feed_configs'] ?? array();

// Get all feeds
$feedDAO = new FreshRSS_FeedDAO();
$feeds = $feedDAO->listFeeds();
?>

<form action="<?php echo _url('extension', 'configure', 'e', urlencode($this->getName())); ?>" method="post" enctype="multipart/form-data">
    <input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>"/>

    <div class="post">
        <h2>Global Settings</h2>

        <div class="form-group">
            <label class="group-name" for="api_endpoint">API Endpoint</label>
            <div class="group-controls">
                <input type="text" id="api_endpoint" name="api_endpoint"
                    value="<?php echo htmlspecialchars($apiEndpointDisplay); ?>"
                    placeholder="https://api.openai.com/v1/chat/completions"
                    style="width: 100%;">
                <p class="help">OpenAI-compatible API endpoint (e.g., OpenAI, Azure OpenAI, LocalAI, Ollama with OpenAI compatibility layer)</p>
            </div>
        </div>

        <div class="form-group">
            <label class="group-name" for="api_token">API Access Token</label>
            <div class="group-controls">
                <input type="password" id="api_token" name="api_token"
                    value="<?php echo htmlspecialchars($apiTokenDisplay); ?>"
                    placeholder="sk-..."
                    style="width: 100%;">
                <p class="help">Your API access token (kept secure, never logged)</p>
            </div>
        </div>

        <div class="form-group">
            <label class="group-name" for="model">AI Model</label>
            <div class="group-controls">
                <select id="model" name="model" style="width: 100%;">
                    <option value="gpt-4o" <?php echo $model === 'gpt-4o' ? 'selected' : ''; ?>>GPT-4o (Best quality, slower)</option>
                    <option value="gpt-4o-mini" <?php echo $model === 'gpt-4o-mini' ? 'selected' : ''; ?>>GPT-4o Mini (Recommended - Fast & cost-effective)</option>
                    <option value="gpt-4-turbo" <?php echo $model === 'gpt-4-turbo' ? 'selected' : ''; ?>>GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo" <?php echo $model === 'gpt-3.5-turbo' ? 'selected' : ''; ?>>GPT-3.5 Turbo (Fastest, cheapest)</option>
                    <option value="claude-3-5-sonnet-20241022" <?php echo $model === 'claude-3-5-sonnet-20241022' ? 'selected' : ''; ?>>Claude 3.5 Sonnet (for Anthropic API)</option>
                    <option value="claude-3-5-haiku-20241022" <?php echo $model === 'claude-3-5-haiku-20241022' ? 'selected' : ''; ?>>Claude 3.5 Haiku (for Anthropic API)</option>
                </select>
                <p class="help">Choose the AI model to use. Faster models process articles quicker but may have lower quality. For local AI (Ollama/LocalAI), use the model name you have installed.</p>
            </div>
        </div>

        <div class="form-group">
            <label class="group-name" for="default_prompt">Default Prompt</label>
            <div class="group-controls">
                <textarea id="default_prompt" name="default_prompt"
                    rows="10"
                    placeholder="Enter the default prompt for AI processing..."
                    style="width: 100%; font-family: monospace;"><?php echo htmlspecialchars($defaultPromptDisplay); ?></textarea>
                <p class="help">Default prompt used for all feeds unless overridden. The article content will be appended after this prompt.</p>
            </div>
        </div>
    </div>

    <div class="post" style="margin-top: 2em;">
        <h2>Per-Feed Configuration</h2>
        <p>Enable AI conversion for specific feeds and optionally customize the prompt for each feed.</p>
    </div>

    <?php if (empty($feeds)): ?>
        <div class="form-group">
            <div class="group-controls">
                <p>No feeds configured. Please add a feed first.</p>
            </div>
        </div>
    <?php else: ?>
        <?php foreach ($feeds as $feed): ?>
            <?php
            $feedId = $feed->id();
            $feedConfig = $feedConfigs[$feedId] ?? array();
            $enabled = $feedConfig['enabled'] ?? false;
            $customPrompt = $feedConfig['custom_prompt'] ?? '';
            $customPromptDisplay = html_entity_decode($customPrompt, ENT_QUOTES, 'UTF-8');
            ?>

            <fieldset class="form-group feed-config post" data-feed-id="<?php echo $feedId; ?>">
                <legend><?php echo htmlspecialchars($feed->name()); ?></legend>

                <input type="hidden" name="feed_ids[]" value="<?php echo $feedId; ?>">

                <div class="form-group">
                    <label class="group-name">
                        <input type="checkbox" name="aiconverter_enabled_<?php echo $feedId; ?>"
                            value="1" <?php echo $enabled ? 'checked' : ''; ?>>
                        Enable AI Conversion
                    </label>
                </div>

                <div class="form-group">
                    <label class="group-name" for="aiconverter_custom_prompt_<?php echo $feedId; ?>">Custom Prompt (optional)</label>
                    <div class="group-controls">
                        <textarea id="aiconverter_custom_prompt_<?php echo $feedId; ?>"
                            name="aiconverter_custom_prompt_<?php echo $feedId; ?>"
                            rows="6"
                            placeholder="Leave empty to use the default prompt..."
                            style="width: 100%; font-family: monospace;"><?php echo htmlspecialchars($customPromptDisplay); ?></textarea>
                        <p class="help">If specified, this prompt will be used instead of the default prompt for this feed.</p>
                    </div>
                </div>

                <button type="button" class="btn btn-attention btn-reload-feed-aiconverter" data-feed-id="<?php echo $feedId; ?>">Reload Feed</button>
            </fieldset>
        <?php endforeach; ?>
    <?php endif; ?>

    <div class="form-group form-actions">
        <div class="group-controls">
            <button type="submit" class="btn btn-important">Submit</button>
            <button type="reset" class="btn">Cancel</button>
        </div>
    </div>
</form>
